#!/bin/sh

set -eu

if which goctest >/dev/null; then
    goctest="goctest"
else
    goctest="go test"
fi

QUICK=""
if [ "${1:-}" = "--quick" ]; then
    QUICK=yes
fi

echo Checking docs
./mdlint.py docs/*.md

echo Checking formatting
fmt=$(gofmt -l .)

if [ -n "$fmt" ]; then
    echo "Formatting wrong in following files"
    echo "$fmt"
    exit 1
fi

if [ -z "$QUICK" ]; then
    echo Installing godeps
    go get launchpad.net/godeps
    export PATH=$PATH:$GOPATH/bin

    echo Install golint
    go get github.com/golang/lint/golint
    export PATH=$PATH:$GOPATH/bin

    echo Obtaining dependencies
    godeps -u dependencies.tsv

    echo Building
    go build -v launchpad.net/snappy/...


    # tests
    echo Running tests from $(pwd)
    $goctest -v -cover ./...
fi

# go vet
echo Running vet
go vet ./...
go vet ./_integration-tests/tests/...
go vet ./_integration-tests/testutils/...

# golint
echo Running lint
lint=$(golint ./... && golint ./_integration-tests/testutils/... && golint ./_integration-tests/tests/...)
if [ -n "$lint" ]; then
    echo "Lint complains:"
    echo "$lint"
    exit 1
fi

# pot file
TMPF="$(mktemp)"
./update-pot "$TMPF"
trap "rm -f $TMPF" 0
if ! diff -u --ignore-matching-lines=.*POT-Creation-Date.* po/snappy.pot $TMPF; then
    echo "You need to run ./update-pot"
    exit 1
fi


if [ -z "$QUICK" ]; then
    # integration tests
    echo Building the integration tests
    go build _integration-tests/main.go

    # the rabbit hole
    echo Running the tests for the integration testutils
    $goctest -v -cover ./_integration-tests/testutils/...

    # integration suite in kvm
    if which adt-run >/dev/null 2>&1; then
        echo "Running integration tests on rolling edge"
        result=0
        go run _integration-tests/main.go --snappy-from-branch --filter searchSuite || result=$?
        # print the results.
        if which subunit2pyunit >/dev/null 2>&1; then
            subunit-1to2 /tmp/snappy-test/output/artifacts/results.subunit | subunit2pyunit
        fi
        if [ "$result" -ne 0 ]; then
            echo "Integration tests failed"
            exit $result
        fi
    fi
fi

echo "All good, what could possibly go wrong"
