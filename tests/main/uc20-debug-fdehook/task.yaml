summary: Integration tests for the fde-setup hook runner

# use the same system and tooling as uc20
systems: [ubuntu-20.04-64]

environment:
    GO111MODULE: off

execute: |
    mkdir -p test-snapd-fde-setup/meta/hooks
    go build -o test-snapd-fde-setup/meta/hooks/fde-setup "$TESTSLIB"/fde-setup.go
    #shellcheck source=tests/lib/snaps.sh
    . "$TESTSLIB"/snaps.sh
    install_local ./test-snapd-fde-setup

    # XXX: uses the fde-debug action, this should be replaced with a proper
    #      nested end-to-end test
    sealed_key_debug_json=$(curl -sS --unix-socket /run/snapd.socket http://localhost/v2/debug -X POST -d '{"action":"fde-setup","message":"initial-setup,test-snapd-fde-setup,ABCDEabcde,key-name"}')
    echo "$sealed_key_debug_json" | jq .result | MATCH '[0-9]+'


