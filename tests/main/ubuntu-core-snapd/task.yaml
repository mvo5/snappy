summary: Test snapd install on a UC16 system

# snapd snap is already installed by default on uc18+
systems: [ubuntu-core-16-*]

execute: |
    if [ "$SPREAD_REBOOT" = 0 ]; then
        echo "No snapd snap is installed"
        not snap list snapd
    
        echo "Ensure the snapd snap can be installed"
        snap install snapd

        echo "And it is considered installed"
        snap list snapd

        echo "And snapd from the snap is run in the CGroup"
        systemctl status snapd|MATCH "/snap/snapd/[0-9]+/usr/lib/snapd/snapd"

        echo "And after a reboot the snapd snap is still ok"
        REBOOT
    elif [ "$SPREAD_REBOOT" = 1 ]; then
        echo "still installed"
        snap list snapd
        echo "and running the right snapd"
        systemctl status snapd|MATCH "/snap/snapd/[0-9]+/usr/lib/snapd/snapd"

        # we cannot restore in "restore:" because there is the rsync
        # snap running there and it will try to refresh the sytem-key
        systemctl stop snapd.service snapd.socket
        rm -f /etc/systemd/system/snapd.*.{service,timer,socket}
        rm -f /etc/systemd/system/*.wants/snapd.*.{service,timer,socket}
        systemctl daemon-reload
        systemctl start snapd snapd.socket
        rsync --help
    fi
